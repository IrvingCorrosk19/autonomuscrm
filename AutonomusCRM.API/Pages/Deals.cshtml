@page
@model AutonomusCRM.API.Pages.DealsModel
@using AutonomusCRM.Application.Deals.Queries
@using AutonomusCRM.Domain.Deals
@{
    ViewData["Title"] = "Pipeline - AUTONOMUS CRM";
}

<!-- TOPBAR -->
<header class="topbar">
  <div class="topbar-left">
    <div class="kicker">Pipeline de ventas</div>
    <h2 class="headline">Oportunidades con estrategia IA</h2>
  </div>

  <div class="topbar-center">
    <div class="search" role="search">
      <input type="text" placeholder="Buscar deals por cliente, monto..." aria-label="Buscar" />
      <span class="chip">Filtros</span>
      <span class="chip">Vista</span>
    </div>
  </div>

  <div class="topbar-right">
    <button class="btn mobile-toggle" type="button" onclick="toggleSidebar()">Menú</button>
    <button class="btn" type="button">Exportar</button>
    <button class="btn primary" type="button" onclick="document.getElementById('create-deal-form').style.display='block'">Nuevo Deal</button>
  </div>
</header>

<!-- STATS -->
<section class="stats" aria-label="Métricas del pipeline">
  <div class="stat">
    <div class="label">Pipeline total</div>
    <div class="value">$ @Model.Deals.Where(d => d.Status == DealStatus.Open).Sum(d => d.Amount).ToString("N0")</div>
    <div class="hint">
      <span>Valor estimado</span>
      <span class="delta up">@Model.Deals.Count(d => d.Status == DealStatus.Open) activos</span>
    </div>
  </div>

  <div class="stat">
    <div class="label">Deals activos</div>
    <div class="value">@Model.Deals.Count(d => d.Status == DealStatus.Open)</div>
    <div class="hint">
      <span>En proceso</span>
      <span class="delta up">@Model.Deals.Count total</span>
    </div>
  </div>

  <div class="stat">
    <div class="label">Probabilidad promedio</div>
    <div class="value">@(Model.Deals.Any() && Model.Deals.Any(d => d.Probability.HasValue) ? Model.Deals.Where(d => d.Probability.HasValue).Average(d => d.Probability!.Value).ToString("F0") : "0")%</div>
    <div class="hint">
      <span>Calculado por IA</span>
      <span class="delta up">@Model.Deals.Count(d => d.Probability.HasValue && d.Probability > 70) altos</span>
    </div>
  </div>

  <div class="stat">
    <div class="label">Cierre estimado</div>
    <div class="value">$ @Model.Deals.Where(d => d.Status == DealStatus.Open && d.ExpectedCloseDate.HasValue && d.ExpectedCloseDate.Value <= DateTime.UtcNow.AddDays(30)).Sum(d => d.Amount * (d.Probability ?? 0) / 100).ToString("N0")</div>
    <div class="hint">
      <span>Próximos 30 días</span>
      <span class="delta up">@Model.Deals.Count(d => d.ExpectedCloseDate.HasValue && d.ExpectedCloseDate.Value <= DateTime.UtcNow.AddDays(30)) deals</span>
    </div>
  </div>
</section>

<section class="grid">
  <!-- LEFT: Pipeline Kanban -->
  <div class="card">
    <div class="card-h">
      <div>
        <h3 class="title">Pipeline visual</h3>
        <p class="subtitle">
          Oportunidades organizadas por etapa con recomendaciones automáticas de la IA para maximizar el cierre.
        </p>
      </div>
      <span class="pill">@Model.Deals.Count deals</span>
    </div>

    <div class="card-b">
      <div class="pipeline" aria-label="Etapas del pipeline">
        @if (Model.Deals.Any())
        {
          <div class="stage">
            <div class="head">
              <div class="name">Prospección</div>
              <div class="sum">$ @Model.Deals.Where(d => d.Stage == DealStage.Prospecting).Sum(d => d.Amount).ToString("N0")</div>
            </div>
            @foreach (var deal in Model.Deals.Where(d => d.Stage == DealStage.Prospecting && d.Status == DealStatus.Open).Take(2))
            {
              <div class="deal">
                <div class="dtitle">@deal.Title · $@deal.Amount.ToString("N0")</div>
                <div class="dmeta"><span>Prob: @(deal.Probability ?? 0)%</span><span>IA: Calificar</span></div>
                <div class="bar"><span style="width:@(deal.Probability ?? 0)%"></span></div>
              </div>
            }
            @if (!Model.Deals.Any(d => d.Stage == DealStage.Prospecting))
            {
              <div class="deal"><div class="dtitle">No hay deals en prospección</div></div>
            }
          </div>

          <div class="stage">
            <div class="head">
              <div class="name">Calificación</div>
              <div class="sum">$ @Model.Deals.Where(d => d.Stage == DealStage.Qualification).Sum(d => d.Amount).ToString("N0")</div>
            </div>
            @foreach (var deal in Model.Deals.Where(d => d.Stage == DealStage.Qualification && d.Status == DealStatus.Open).Take(2))
            {
              <div class="deal">
                <div class="dtitle">@deal.Title · $@deal.Amount.ToString("N0")</div>
                <div class="dmeta"><span>Prob: @(deal.Probability ?? 0)%</span><span>IA: Propuesta</span></div>
                <div class="bar"><span style="width:@(deal.Probability ?? 0)%"></span></div>
              </div>
            }
            @if (!Model.Deals.Any(d => d.Stage == DealStage.Qualification))
            {
              <div class="deal"><div class="dtitle">No hay deals en calificación</div></div>
            }
          </div>

          <div class="stage">
            <div class="head">
              <div class="name">Propuesta</div>
              <div class="sum">$ @Model.Deals.Where(d => d.Stage == DealStage.Proposal).Sum(d => d.Amount).ToString("N0")</div>
            </div>
            @foreach (var deal in Model.Deals.Where(d => d.Stage == DealStage.Proposal && d.Status == DealStatus.Open).Take(2))
            {
              <div class="deal">
                <div class="dtitle">@deal.Title · $@deal.Amount.ToString("N0")</div>
                <div class="dmeta"><span>Prob: @(deal.Probability ?? 0)%</span><span>IA: Negociar</span></div>
                <div class="bar"><span style="width:@(deal.Probability ?? 0)%"></span></div>
              </div>
            }
            @if (!Model.Deals.Any(d => d.Stage == DealStage.Proposal))
            {
              <div class="deal"><div class="dtitle">No hay deals en propuesta</div></div>
            }
          </div>

          <div class="stage">
            <div class="head">
              <div class="name">Negociación</div>
              <div class="sum">$ @Model.Deals.Where(d => d.Stage == DealStage.Negotiation).Sum(d => d.Amount).ToString("N0")</div>
            </div>
            @foreach (var deal in Model.Deals.Where(d => d.Stage == DealStage.Negotiation && d.Status == DealStatus.Open).Take(2))
            {
              <div class="deal">
                <div class="dtitle">@deal.Title · $@deal.Amount.ToString("N0")</div>
                <div class="dmeta"><span>Prob: @(deal.Probability ?? 0)%</span><span>IA: Cerrar</span></div>
                <div class="bar"><span style="width:@(deal.Probability ?? 0)%"></span></div>
              </div>
            }
            @if (!Model.Deals.Any(d => d.Stage == DealStage.Negotiation))
            {
              <div class="deal"><div class="dtitle">No hay deals en negociación</div></div>
            }
          </div>
        }
        else
        {
          <div class="stage">
            <div class="head"><div class="name">No hay deals disponibles</div></div>
            <div class="deal"><div class="dtitle">Crea tu primer deal para comenzar</div></div>
          </div>
        }
      </div>

      <div style="height:14px"></div>

      <table class="table" aria-label="Recomendaciones de IA">
        <thead>
          <tr>
            <th>Recomendación</th>
            <th>Deal</th>
            <th>Impacto</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          @if (Model.Deals.Any())
          {
            @foreach (var deal in Model.Deals.Where(d => d.Probability < 50 && d.Status == DealStatus.Open).Take(3))
            {
              <tr>
                <td>Revisar deal con baja probabilidad de cierre</td>
                <td>@deal.Title · $@deal.Amount.ToString("N0")</td>
                <td><span class="badge @(deal.Probability < 30 ? "danger" : "warn")">@(deal.Probability < 30 ? "Crítico" : "Alto")</span></td>
                <td><span class="badge">Pendiente</span></td>
              </tr>
            }
            @if (!Model.Deals.Any(d => d.Probability < 50))
            {
              <tr>
                <td colspan="4" style="text-align: center; color: rgba(255,255,255,0.5);">No hay recomendaciones pendientes</td>
              </tr>
            }
          }
          else
          {
            <tr>
              <td colspan="4" style="text-align: center; color: rgba(255,255,255,0.5);">Crea deals para ver recomendaciones</td>
            </tr>
          }
        </tbody>
      </table>

      <div style="height:12px"></div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn" type="button">Ver detalles</button>
        <button class="btn" type="button">Simular escenarios</button>
        <button class="btn primary" type="button">Aprobar acciones</button>
      </div>
    </div>
  </div>

  <!-- RIGHT: Strategy Panel -->
  <aside class="stack">
    <div class="card">
      <div class="card-h">
        <div>
          <h3 class="title">Estrategia de cierre</h3>
          <p class="subtitle">Recomendaciones automáticas basadas en análisis de probabilidad y timing.</p>
        </div>
        <span class="pill">IA Strategy</span>
      </div>
      <div class="card-b">
        <div class="feed">
          <div class="item">
            <div class="itop">
              <div class="itag">ESTRATEGIA</div>
              <div class="itime">Hace 8 min</div>
            </div>
            <div class="ibody">
              "Renovación E" tiene alta probabilidad (72%). Recomendación: ajustar precio 8% para cerrar esta semana.
            </div>
            <div class="ifooter">
              <span class="pill">Confianza: 0.85</span>
              <span class="pill">Impacto: $85K</span>
            </div>
          </div>

          <div class="item">
            <div class="itop">
              <div class="itag">RIESGO</div>
              <div class="itime">Hace 15 min</div>
            </div>
            <div class="ibody">
              "Grupo B" sin actividad en 12 días. Probabilidad cayó 12%. Acción urgente requerida.
            </div>
            <div class="ifooter">
              <span class="pill">Riesgo: Alto</span>
              <span class="pill">Acción: Reactivar</span>
            </div>
          </div>

          <div class="item">
            <div class="itop">
              <div class="itag">OPORTUNIDAD</div>
              <div class="itime">Hace 30 min</div>
            </div>
            <div class="ibody">
              Patrón detectado: deals de $50K+ tienen 40% más probabilidad si se cierran en Q4.
            </div>
            <div class="ifooter">
              <span class="pill">Timing: Q4</span>
              <span class="pill">Prioridad: Alta</span>
            </div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" type="button">Ver análisis</button>
          <button class="btn primary" type="button">Aplicar estrategia</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-h">
        <div>
          <h3 class="title">Forecast inteligente</h3>
          <p class="subtitle">Proyección de cierre basada en probabilidades calculadas por IA.</p>
        </div>
        <span class="pill">Próximos 90 días</span>
      </div>
      <div class="card-b">
        <table class="table" aria-label="Forecast de cierre">
          <thead>
            <tr>
              <th>Período</th>
              <th>Forecast</th>
              <th>Confianza</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Próximos 30 días</td>
              <td>$ 310K</td>
              <td><span class="badge ok">Alta</span></td>
            </tr>
            <tr>
              <td>31-60 días</td>
              <td>$ 185K</td>
              <td><span class="badge warn">Media</span></td>
            </tr>
            <tr>
              <td>61-90 días</td>
              <td>$ 142K</td>
              <td><span class="badge warn">Media</span></td>
            </tr>
          </tbody>
        </table>

        <div style="height:12px"></div>

        <button class="btn primary" type="button" style="width:100%;">Ver forecast detallado</button>
      </div>
    </div>
  </aside>
</section>

<!-- CREATE DEAL FORM -->
<div id="create-deal-form" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:1000; padding:40px; overflow:auto;">
  <div style="max-width:600px; margin:0 auto; background:var(--bg-card); padding:30px; border-radius:8px;">
    <h2 style="margin:0 0 20px 0;">Crear Nuevo Deal</h2>
    <form method="post" asp-page-handler="Create">
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:600;">Cliente *</label>
        <select name="customerId" required style="width:100%; padding:10px; border:1px solid rgba(255,255,255,0.1); background:var(--bg); color:var(--text); border-radius:4px;">
          <option value="">Selecciona un cliente</option>
          @foreach (var customer in Model.Customers)
          {
            <option value="@customer.Id">@customer.Name @(!string.IsNullOrEmpty(customer.Company) ? $"({customer.Company})" : "")</option>
          }
        </select>
        @if (!Model.Customers.Any())
        {
          <p style="color:var(--muted); font-size:12px; margin-top:5px;">No hay clientes. <a href="/Customers" style="color:var(--primary);">Crea uno primero</a></p>
        }
      </div>
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:600;">Título *</label>
        <input type="text" name="title" required style="width:100%; padding:10px; border:1px solid rgba(255,255,255,0.1); background:var(--bg); color:var(--text); border-radius:4px;" />
      </div>
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:600;">Monto *</label>
        <input type="number" name="amount" step="0.01" min="0" required style="width:100%; padding:10px; border:1px solid rgba(255,255,255,0.1); background:var(--bg); color:var(--text); border-radius:4px;" />
      </div>
      <div style="margin-bottom:20px;">
        <label style="display:block; margin-bottom:5px; font-weight:600;">Descripción</label>
        <textarea name="description" rows="3" style="width:100%; padding:10px; border:1px solid rgba(255,255,255,0.1); background:var(--bg); color:var(--text); border-radius:4px;"></textarea>
      </div>
      <div style="display:flex; gap:10px;">
        <button type="submit" class="btn primary" style="flex:1;" @(!Model.Customers.Any() ? "disabled" : "")>Crear Deal</button>
        <button type="button" class="btn" onclick="document.getElementById('create-deal-form').style.display='none'" style="flex:1;">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<div style="height:14px"></div>

<footer style="color:rgba(255,255,255,0.55); font-size:12px; padding:8px 2px;">
  AUTONOMUS CRM · Pipeline inteligente con estrategia de cierre automática.
</footer>

