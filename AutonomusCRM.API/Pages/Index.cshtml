@page
@model IndexModel
@using AutonomusCRM.Application.Leads.Queries
@using AutonomusCRM.Application.Deals.Queries
@using AutonomusCRM.Domain.Leads
@using AutonomusCRM.Domain.Deals
@{
    ViewData["Title"] = "Dashboard - AUTONOMUS CRM";
}

<!-- TOPBAR -->
<header class="topbar">
  <div class="topbar-left">
    <div class="kicker">Dashboard operativo</div>
    <h2 class="headline">Control del negocio en tiempo real</h2>
  </div>

  <div class="topbar-center">
    <div class="search" role="search">
      <input type="text" placeholder="Buscar: cliente, lead, deal, ticket, actividad..." aria-label="Buscar" />
      <span class="chip">Filtros</span>
      <span class="chip">Segmentos</span>
    </div>
  </div>

  <div class="topbar-right">
    <button class="btn mobile-toggle" type="button" onclick="toggleSidebar()">Menú</button>
    <button class="btn" type="button">Aprobar acciones</button>
    <a href="/Leads/Create" class="btn primary">Nuevo Lead</a>
  </div>
</header>

<!-- STATS -->
<section class="stats" aria-label="Métricas clave">
  <div class="stat">
    <div class="label">Leads nuevos</div>
    <div class="value">@Model.ViewModel.NewLeadsLast24h</div>
    <div class="hint">
      <span>Últimas 24h</span>
      <span class="delta up">@Model.ViewModel.TotalLeads total</span>
    </div>
  </div>

  <div class="stat">
    <div class="label">Conversión</div>
    <div class="value">@Model.ViewModel.ConversionRate.ToString("F1")%</div>
    <div class="hint">
      <span>Total leads: @Model.ViewModel.TotalLeads</span>
      <span class="delta up">@Model.ViewModel.Leads.Count(l => l.Status == LeadStatus.Qualified) calificados</span>
    </div>
  </div>

  <div class="stat">
    <div class="label">Deals en riesgo</div>
    <div class="value">@Model.ViewModel.DealsAtRisk</div>
    <div class="hint">
      <span>Detectados por IA</span>
      <span class="delta down">Probabilidad < 50%</span>
    </div>
  </div>

  <div class="stat">
    <div class="label">Ingresos estimados</div>
    <div class="value">$ @Model.ViewModel.EstimatedRevenue.ToString("N0")</div>
    <div class="hint">
      <span>Deals abiertos</span>
      <span class="delta up">@Model.ViewModel.Deals.Count(d => d.Status == DealStatus.Open) activos</span>
    </div>
  </div>
</section>

<section class="grid">
  <!-- LEFT: Pipeline + Table -->
  <div class="card">
    <div class="card-h">
      <div>
        <h3 class="title">Pipeline inteligente</h3>
        <p class="subtitle">
          Estado de oportunidades con recomendaciones automáticas. La IA prioriza acciones, detecta estancamientos y sugiere el siguiente mejor paso.
        </p>
      </div>
      <span class="pill">Actualizado hace 2 min</span>
    </div>

    <div class="card-b">
      <div class="pipeline" aria-label="Etapas del pipeline">
        @if (Model.ViewModel.HasData)
        {
          <div class="stage">
            <div class="head">
              <div class="name">Prospección</div>
              <div class="sum">$ @Model.ViewModel.PipelineProspecting.ToString("N0")</div>
            </div>
            @foreach (var deal in Model.ViewModel.Deals.Where(d => d.Stage == DealStage.Prospecting).Take(2))
            {
              <div class="deal">
                <div class="dtitle">@deal.Title</div>
                <div class="dmeta">
                  <span>Probabilidad: @(deal.Probability ?? 0)%</span>
                  <span>Monto: $@deal.Amount.ToString("N0")</span>
                </div>
                <div class="bar"><span style="width:@(deal.Probability ?? 0)%"></span></div>
              </div>
            }
            @if (!Model.ViewModel.Deals.Any(d => d.Stage == DealStage.Prospecting))
            {
              <div class="deal">
                <div class="dtitle">No hay deals en prospección</div>
              </div>
            }
          </div>

          <div class="stage">
            <div class="head">
              <div class="name">Calificación</div>
              <div class="sum">$ @Model.ViewModel.PipelineQualification.ToString("N0")</div>
            </div>
            @foreach (var deal in Model.ViewModel.Deals.Where(d => d.Stage == DealStage.Qualification).Take(2))
            {
              <div class="deal">
                <div class="dtitle">@deal.Title</div>
                <div class="dmeta">
                  <span>Probabilidad: @(deal.Probability ?? 0)%</span>
                  <span>Monto: $@deal.Amount.ToString("N0")</span>
                </div>
                <div class="bar"><span style="width:@(deal.Probability ?? 0)%"></span></div>
              </div>
            }
            @if (!Model.ViewModel.Deals.Any(d => d.Stage == DealStage.Qualification))
            {
              <div class="deal">
                <div class="dtitle">No hay deals en calificación</div>
              </div>
            }
          </div>

          <div class="stage">
            <div class="head">
              <div class="name">Propuesta</div>
              <div class="sum">$ @Model.ViewModel.PipelineProposal.ToString("N0")</div>
            </div>
            @foreach (var deal in Model.ViewModel.Deals.Where(d => d.Stage == DealStage.Proposal).Take(2))
            {
              <div class="deal">
                <div class="dtitle">@deal.Title</div>
                <div class="dmeta">
                  <span>Probabilidad: @(deal.Probability ?? 0)%</span>
                  <span>Monto: $@deal.Amount.ToString("N0")</span>
                </div>
                <div class="bar"><span style="width:@(deal.Probability ?? 0)%"></span></div>
              </div>
            }
            @if (!Model.ViewModel.Deals.Any(d => d.Stage == DealStage.Proposal))
            {
              <div class="deal">
                <div class="dtitle">No hay deals en propuesta</div>
              </div>
            }
          </div>

          <div class="stage">
            <div class="head">
              <div class="name">Negociación</div>
              <div class="sum">$ @Model.ViewModel.PipelineClosing.ToString("N0")</div>
            </div>
            @foreach (var deal in Model.ViewModel.Deals.Where(d => d.Stage == DealStage.Negotiation).Take(2))
            {
              <div class="deal">
                <div class="dtitle">@deal.Title</div>
                <div class="dmeta">
                  <span>Probabilidad: @(deal.Probability ?? 0)%</span>
                  <span>Monto: $@deal.Amount.ToString("N0")</span>
                </div>
                <div class="bar"><span style="width:@(deal.Probability ?? 0)%"></span></div>
              </div>
            }
            @if (!Model.ViewModel.Deals.Any(d => d.Stage == DealStage.Negotiation))
            {
              <div class="deal">
                <div class="dtitle">No hay deals en cierre</div>
              </div>
            }
          </div>
        }
        else
        {
          <div class="stage">
            <div class="head">
              <div class="name">No hay datos disponibles</div>
            </div>
            <div class="deal">
              <div class="dtitle">Crea tu primer tenant, lead o deal para comenzar</div>
            </div>
          </div>
        }
      </div>

      <div style="height:14px"></div>

      <table class="table" aria-label="Acciones recomendadas por IA">
        <thead>
          <tr>
            <th>Recomendación</th>
            <th>Entidad</th>
            <th>Impacto</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          @if (Model.ViewModel.HasData && Model.ViewModel.Deals.Any())
          {
            @foreach (var deal in Model.ViewModel.Deals.Where(d => d.Probability < 50 && d.Status == DealStatus.Open).Take(3))
            {
              <tr>
                <td>Revisar deal con baja probabilidad de cierre</td>
                <td>Deal · @deal.Title</td>
                <td><span class="badge @(deal.Probability < 30 ? "danger" : "warn")">@(deal.Probability < 30 ? "Crítico" : "Alto")</span></td>
                <td><span class="badge">Pendiente</span></td>
              </tr>
            }
            @foreach (var lead in Model.ViewModel.Leads.Where(l => l.Status == LeadStatus.New).Take(2))
            {
              <tr>
                <td>Calificar lead nuevo</td>
                <td>Lead · @lead.Name</td>
                <td><span class="badge warn">Medio</span></td>
                <td><span class="badge">Pendiente</span></td>
              </tr>
            }
            @if (!Model.ViewModel.Deals.Any(d => d.Probability < 50) && !Model.ViewModel.Leads.Any(l => l.Status == LeadStatus.New))
            {
              <tr>
                <td colspan="4" style="text-align: center; color: rgba(255,255,255,0.5);">No hay recomendaciones pendientes</td>
              </tr>
            }
          }
          else
          {
            <tr>
              <td colspan="4" style="text-align: center; color: rgba(255,255,255,0.5);">Crea leads y deals para ver recomendaciones</td>
            </tr>
          }
        </tbody>
      </table>

      <div style="height:12px"></div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn" type="button">Ver detalles</button>
        <button class="btn" type="button">Simular acciones</button>
        <button class="btn primary" type="button">Aprobar lote</button>
      </div>
    </div>
  </div>

  <!-- RIGHT: Feed + AI Panel -->
  <aside class="stack">
    <div class="card">
      <div class="card-h">
        <div>
          <h3 class="title">Centro de control IA</h3>
          <p class="subtitle">Resumen de lo que la IA está haciendo ahora mismo y por qué.</p>
        </div>
        <span class="pill">Modo: Supervisado</span>
      </div>
      <div class="card-b">
        <div class="feed">
          <div class="item">
            <div class="itop">
              <div class="itag">DECISIÓN</div>
              <div class="itime">Hace 3 min</div>
            </div>
            <div class="ibody">
              Se priorizó "Renovación anual" por alta probabilidad de cierre y alto impacto mensual.
            </div>
            <div class="ifooter">
              <span class="pill">Confianza: 0.82</span>
              <span class="pill">Motivo: historial + timing</span>
              <span class="pill">Acción: propuesta</span>
            </div>
          </div>

          <div class="item">
            <div class="itop">
              <div class="itag">ALERTA</div>
              <div class="itime">Hace 8 min</div>
            </div>
            <div class="ibody">
              "Pago pendiente" presenta riesgo alto por ausencia de respuesta y plazo cercano.
            </div>
            <div class="ifooter">
              <span class="pill">Confianza: 0.77</span>
              <span class="pill">Acción: recordatorio</span>
              <span class="pill">Política: no spamear</span>
            </div>
          </div>

          <div class="item">
            <div class="itop">
              <div class="itag">CALIDAD DE DATOS</div>
              <div class="itime">Hace 16 min</div>
            </div>
            <div class="ibody">
              Se detectaron 6 leads con teléfono incompleto. Se generó tarea de normalización.
            </div>
            <div class="ifooter">
              <span class="pill">Impacto: conversión</span>
              <span class="pill">Estado: en cola</span>
            </div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" type="button">Cambiar modo</button>
          <button class="btn" type="button">Ver auditoría</button>
          <button class="btn primary" type="button">Ajustar políticas</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-h">
        <div>
          <h3 class="title">Experiencia del cliente</h3>
          <p class="subtitle">Lo que está sintiendo el cliente, y lo que hacemos al respecto.</p>
        </div>
        <span class="pill">Últimos 7 días</span>
      </div>
      <div class="card-b">
        <table class="table" aria-label="Indicadores de experiencia">
          <thead>
            <tr>
              <th>Indicador</th>
              <th>Valor</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Tiempo de respuesta</td>
              <td>12 min</td>
              <td><span class="badge ok">Bueno</span></td>
            </tr>
            <tr>
              <td>Satisfacción estimada</td>
              <td>4.6 / 5</td>
              <td><span class="badge ok">Bueno</span></td>
            </tr>
            <tr>
              <td>Tickets reabiertos</td>
              <td>3</td>
              <td><span class="badge warn">Atención</span></td>
            </tr>
          </tbody>
        </table>

        <div style="height:12px"></div>

        <button class="btn primary" type="button" style="width:100%;">Plan de mejora automático</button>
      </div>
    </div>
  </aside>
</section>

<div style="height:14px"></div>

<footer style="color:rgba(255,255,255,0.55); font-size:12px; padding:8px 2px;">
  AUTONOMUS CRM · Sistema autónomo de gestión empresarial · Enfocado en claridad, confianza y acción rápida.
</footer>
